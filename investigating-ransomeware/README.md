# Investigating Ransomware with Splunk

## Overview
Conducting investigations is a core component of cybersecurity. When we detect something, it's essential to figure out what happened by asking questions like: who, what, where, when, why, and how. Investigations can be either reactive or proactive, depending on the context.

## Components of Investigation
1. **Incident Response:**
   - Immediate actions taken to address and mitigate an ongoing security incident.
   - Includes containment, eradication, and recovery processes.
   
2. **Threat Hunting:**
   - Proactively searching for signs of malicious activity within an environment.
   - Aims to identify threats that may have evaded traditional security measures.
   
3. **Insider Threat Detection:**
   - Monitoring and detecting suspicious or malicious activities carried out by authorized users within the organization.
   - Helps prevent data breaches and insider attacks.
   
4. **Security Operations:**
   - The ongoing, day-to-day activities related to managing and maintaining security within an organization.
   - Involves monitoring, analyzing, and responding to security alerts and events.

## Data Types Utilized in the Workshop
1. **Microsoft Sysmon:**
   - A Windows system service that logs detailed information about process creations, network connections, and more.
   
2. **Windows Events:**
   - Log files generated by the Windows operating system, containing information about system events and activities.
   
3. **Windows Registry:**
   - A hierarchical database used by the Windows operating system to store configuration settings and options.
   
4. **IIS (Internet Information Services):**
   - A web server software package created by Microsoft.
   - Logs generated by IIS can provide insights into web server activity and potential security issues.
   
5. **Splunk Stream (wire data):**
   - A Splunk component used for capturing, indexing, and analyzing wire data (network traffic).
   - Helps in monitoring network activity and detecting suspicious patterns or anomalies.
   
6. **Suricata:**
   - An open-source intrusion detection and prevention system (IDS/IPS).
   - Provides real-time traffic analysis and alerts on suspicious network activities.
   
7. **Fortigate (NGFW - Next-Generation Firewall):**
   - A firewall appliance developed by Fortinet that incorporates features such as intrusion prevention, antivirus filtering, and application control.
   - Logs generated by Fortigate can provide insights into network traffic and security events.

## Scenario: Investigating Cerber Ransomware Attack at Wayne Enterprises

### Incident Overview:
- **Date and Time:** August 24, 2016
- **Affected Machine:** we8105desk
- **Type of Attack:** Ransomware (Cerber)
- **Impact:** Data encryption, potential data loss, disruption of operations

### 1. Identifying the IP Address of a Victim System

**Question:** What was the most likely IP address of we8105desk on August 24, 2016?

**Procedure:** Since we are given an identifier of the host and timestamp, we can use this to examine the logs.

- By searching `"index=botsv1 we8105desk"` and adjusting the specific timestamp to August 24, 2016, we can now access all the data sources related to the incident.
![image_1](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/c170cedc-84af-4f01-8a9a-583d1d906c7d)

- By clicking the host on the left side fields, we can see the top host.
![image2](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/f5c2408d-9366-474c-a429-a39f5cb70e59)

- By clicking the source on the left side fields, we can see the top source.
![image3](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/e1d0ebd5-9153-498a-be21-2a9becb1fd9f)

- There are a lot of commands to get the same results you want in Splunk. For this, I will use the `top` command to get the top 10 by default `src_ip` by searching the query below:

    ```spl
    index=botsv1 we8105desk sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational | top src_ip
    ```
    ![image4](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/700b56a4-3fb4-41e5-951b-97bf7cff8af9)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100

### 2. Identifying Removable Media

**Question:** What is the name of the USB key inserted by Bob Smith?

If we don’t know much about USB drives and Windows, the first thing you could do is Google for something like the search terms below and do some reading:

- finding the usb name in windows registry logs
- finding windows registry usb name site:microsoft.com

**Resources:**
- [USB Device Registry Entries]([usb_device_registry_entries_link](https://learn.microsoft.com/en-gb/windows-hardware/drivers/usbcon/?redirectedfrom=MSDN))
- [Splunk Answers - USB Detection]([splunk_answers_usb_detection_link](https://community.splunk.com/t5/Splunk-Search/Finding-USB-and-Removable-Media-Detection/td-p/273918))

**Sourcetypes:**
- Winregistry

By searching `“index=botsv1 sourcetype=winregistry friendlyname”`, we can use the “friendlyname” keyword given in the article.

![image5](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/045b15cd-0c3c-410f-b890-2332d1e9a66c)

- Expand the raw logs to see the full details of the logs as well as the different fields. By doing this you can look for fields that you can use to filter much more specific events related to this USB.

![image6](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/b85f85e7-8b0e-4573-84f7-ff89aae60316)

- Based on the search filter we have gathered, I built an optimized and specific search query to find the USB key name:

    ```
    (index=botsv1 sourcetype=winregistry object=friendlyname object_category=registry dest=we8105desk event_status="(0)The operation completed successfully.")
    | table user, object, dest, _time, data, status 
    | rename user as who, object as what, dest as where, _time as when, data as usb_key_name 
    | convert ctime(when)
    ```

![image7](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/de5ab933-c0da-4ab5-be13-b7e59c397774)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI

### 3. Identifying the Malicious File

**Question:** After the USB insertion, a file execution occurs that is the initial Cerber infection. This file execution creates two additional processes. What is the name of the file?

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

- Using the search query provided on the Splunk App, we can find the infected system on an external drive:

   ```
      index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational host=we8105desk (CommandLine="*d:\\*" OR ParentCommandLine="*d:\\*") 
      | table _time CommandLine ParentCommandLine 
      | sort _time
   ```

![image8](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/3407bf4f-6fe5-4f2f-8664-55e25dc61777)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm 

### 4. Identifying Suspicious Processes Executing

**Question:** During the initial Cerber infection, a VB script is run. The entire script from this execution, pre-pended by the name of the launching .exe, can be found in a field in Splunk. What is the length in characters of this field?

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

Using the initial search provided by the app, we can see all the executable files:
![image9](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/29e1219b-e76a-4549-a2d8-e281ee680ec8)

Expanding all the fields on the left side screen, we see the field name "CommandLine":
![image10](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/cbadabb2-25de-4162-8b1b-e15d36781f93)

Using the Text Function "len" to return the character length of a string, we can find the command with the top length:

![image10](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/9fc3cef3-3a4e-4fad-aef3-f75f979eca91)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm


