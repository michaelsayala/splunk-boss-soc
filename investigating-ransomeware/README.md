![image](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/4ea8b705-5910-466c-acf8-c58f170161e7)
# Investigating Ransomware with Splunk

## Overview
Conducting investigations is a core component of cybersecurity. When we detect something, it's essential to figure out what happened by asking questions like: who, what, where, when, why, and how. Investigations can be either reactive or proactive, depending on the context.

## Components of Investigation
1. **Incident Response:**
   - Immediate actions taken to address and mitigate an ongoing security incident.
   - Includes containment, eradication, and recovery processes.
   
2. **Threat Hunting:**
   - Proactively searching for signs of malicious activity within an environment.
   - Aims to identify threats that may have evaded traditional security measures.
   
3. **Insider Threat Detection:**
   - Monitoring and detecting suspicious or malicious activities carried out by authorized users within the organization.
   - Helps prevent data breaches and insider attacks.
   
4. **Security Operations:**
   - The ongoing, day-to-day activities related to managing and maintaining security within an organization.
   - Involves monitoring, analyzing, and responding to security alerts and events.

## Data Types Utilized in the Workshop
1. **Microsoft Sysmon:**
   - A Windows system service that logs detailed information about process creations, network connections, and more.
   
2. **Windows Events:**
   - Log files generated by the Windows operating system, containing information about system events and activities.
   
3. **Windows Registry:**
   - A hierarchical database used by the Windows operating system to store configuration settings and options.
   
4. **IIS (Internet Information Services):**
   - A web server software package created by Microsoft.
   - Logs generated by IIS can provide insights into web server activity and potential security issues.
   
5. **Splunk Stream (wire data):**
   - A Splunk component used for capturing, indexing, and analyzing wire data (network traffic).
   - Helps in monitoring network activity and detecting suspicious patterns or anomalies.
   
6. **Suricata:**
   - An open-source intrusion detection and prevention system (IDS/IPS).
   - Provides real-time traffic analysis and alerts on suspicious network activities.
   
7. **Fortigate (NGFW - Next-Generation Firewall):**
   - A firewall appliance developed by Fortinet that incorporates features such as intrusion prevention, antivirus filtering, and application control.
   - Logs generated by Fortigate can provide insights into network traffic and security events.

## Scenario: Investigating Cerber Ransomware Attack at Wayne Enterprises

### Incident Overview:
- **Date and Time:** August 24, 2016
- **Affected Machine:** we8105desk
- **Type of Attack:** Ransomware (Cerber)
- **Impact:** Data encryption, potential data loss, disruption of operations

### 1. Identifying the IP Address of a Victim System

**Question:** What was the most likely IP address of we8105desk on August 24, 2016?

**Procedure:** Since a timestamp and hostname are provided, we can use these details to find the IP address of we8105desk.

- By searching for "index=botsv1 we8105desk" and adjusting the timestamp to August 24, 2016, we can now access all the data sources related to the incident.
     ```
      index=botsv1 we8105desk
     ```
![image_1](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/c170cedc-84af-4f01-8a9a-583d1d906c7d)

- By clicking on the 'host' field on the left side, we can view the top hosts.
![image2](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/f5c2408d-9366-474c-a429-a39f5cb70e59)

- By clicking on the 'source' field in the left-hand panel, we can see the top sources."
![image3](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/e1d0ebd5-9153-498a-be21-2a9becb1fd9f)

- There are several commands available in Splunk to achieve the desired results. In this case, I will utilize the top command to retrieve the top 10 src_ip by default. Upon observation, the top IP for the src_ip field is "192.168.250.100". We can assume that this is the hostname we are looking for.

    ```spl
    index=botsv1 we8105desk sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational | top src_ip
    ```
    ![image4](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/700b56a4-3fb4-41e5-951b-97bf7cff8af9)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100

### 2. Identifying Removable Media

**Question:** What is the name of the USB key inserted by Bob Smith?

If you're unfamiliar with USB drives and Windows, a good starting point is to conduct a Google search using terms like the following and read through relevant resources: These articles were provided in the Splunk App.

Finding the USB name in Windows registry logs
Finding Windows registry USB name site:microsoft.com

**Resources:**
- [USB Device Registry Entries]([usb_device_registry_entries_link](https://learn.microsoft.com/en-gb/windows-hardware/drivers/usbcon/?redirectedfrom=MSDN))
- [Splunk Answers - USB Detection]([splunk_answers_usb_detection_link](https://community.splunk.com/t5/Splunk-Search/Finding-USB-and-Removable-Media-Detection/td-p/273918))

**Sourcetypes:**
- Winregistry

By searching "index=botsv1 sourcetype=winregistry friendlyname", we can utilize the "friendlyname" keyword provided in the article.
   ```
      index=botsv1 sourcetype=winregistry friendlyname
   ```
![image5](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/045b15cd-0c3c-410f-b890-2332d1e9a66c)

- Expand the raw logs to view the complete details of the logs, including different fields. This allows you to identify fields that can be used to filter more specific events related to this USB.

![image6](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/b85f85e7-8b0e-4573-84f7-ff89aae60316)

- Based on the search filter we have gathered, I have constructed an optimized and specific search query to find the USB key name:

    ```
    (index=botsv1 sourcetype=winregistry object=friendlyname object_category=registry dest=we8105desk event_status="(0)The operation completed successfully.")
    | table user, object, dest, _time, data, status 
    | rename user as who, object as what, dest as where, _time as when, data as usb_key_name 
    | convert ctime(when)
    ```

![image7](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/de5ab933-c0da-4ab5-be13-b7e59c397774)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI

### 3. Identifying the Malicious File

**Question:** After the USB insertion, a file execution occurs that is the initial Cerber infection. This file execution creates two additional processes. What is the name of the file?

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

- Using the search query provided in the Splunk App, we can identify the infected system on an external drive:

   ```
      index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational host=we8105desk (CommandLine="*d:\\*" OR ParentCommandLine="*d:\\*") 
      | table _time CommandLine ParentCommandLine 
      | sort _time
   ```

![image8](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/3407bf4f-6fe5-4f2f-8664-55e25dc61777)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm 

### 4. Identifying Suspicious Processes Executing

**Question:** During the initial Cerber infection, a VB script is run. The entire script from this execution, pre-pended by the name of the launching .exe, can be found in a field in Splunk. What is the length in characters of this field?

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

- Using the initial search provided by the app, we can retrieve all the executable files:
   ```
      index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational *.exe
   ```
![image9](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/5b0ad6f3-2a49-4890-9872-c6cb1ca79455)

- Expanding all the fields on the left side of the screen, we find the field named "CommandLine".
![image10](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/cbadabb2-25de-4162-8b1b-e15d36781f93)

- Using the Text Function "len" to return the character length of a string, we can identify the command with the longest length:
   ```
      index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational *.exe CommandLine=* host=we8105desk EventCode=1 
      | eval length=len(CommandLine) 
      | table CommandLine length 
      | sort - length
   ```
![image10](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/9fc3cef3-3a4e-4fad-aef3-f75f979eca91)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm

### 5. Identifying File Server Connections from Infected Host

**Question:** Bob Smith's workstation (`we8105desk`) was connected to a file server during the ransomware outbreak. What is the IP address of the file server?

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational, winregistry

- Using our threat details search again for the host and finding the top destination IP address:

  ```
     index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational host=we8105desk src=we8105desk.waynecorpinc.local 
     | top dest_ip
  ```
![image11](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/e03c9e6b-324d-4d3d-b65d-e8511ed7553c)

- To view all file shares that occurred on the host using the keyword "fileshare" in winregistry logs, you can execute the following search query:
![image12](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/fe093dd5-1ad0-4a7f-bb8c-ac1164b971c5)

- Expanding the raw logs to view the file path of the file share, we can utilize the "key_path" field name to retrieve the top file path:
![image13](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/854a9f67-76f6-4d13-8bee-64f420865dde)

- To obtain the hostname corresponding to the IP address involved in the file share, you can filter the IP address and then use the "top" command on the "dest_host" field name:

   ```
      index=botsv1 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" 192.168.250.20 
      | top dest_host
   ```
![image14](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/b52821b4-13db-4b95-b35c-30dcf33a9c68)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm 

## File Server
- **Hostname:** we9041srv
- **IP Address:** 192.168.250.20

### 6. Identifying the First Suspect Domain Visited by the Victim

**Question:** What was the first suspicious domain visited by we8105desk on August 24, 2016?

**Sourcetypes:**
- stream:dns

- To find the historical traffic from the IP address "192.168.250.100", I initiated the following search:
   ```
      index=botsv1 sourcetype=stream:DNS src=192.168.250.100
   ```
   ![image15](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/4346acee-fe95-4c8b-b7b6-bbe5fb59fb62)

- By using the app filter to exclude legitimate domains and specifying the source and destination IP addresses, it became easier to identify the traffic:
    ```
          index=botsv1 sourcetype=stream:DNS src=192.168.250.100 record_type=A NOT (query{}=*.microsoft.com OR query{}=*.waynecorpinc.local OR query{}=*.bing.com 
          OR query{}=isatap OR query{}=wpad OR query{}=*.windows.com OR query{}=*.msftncsi.com) 
          | table _time query{} src dest 
          | reverse 
    ```
   ![image16](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/638dea72-fea2-4d05-bc21-333f4d284b3d)

  
  ### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm 

## File Server
- **Hostname:** we9041srv
- **IP Address:** 192.168.250.20

### Initial Connection
- solidaritedeproximite.org
    
### 7. Identifying Cryptor Code Filename and Origin

**Question:** The malware downloads a file that contains the Cerber ransomware cryptor code. What is the name of that file?

**Sourcetypes:**
- stream:http, suricata, fgt_utm

- Starting with the source IP address "192.168.250.100" and the suspicious domain "solidaritedeproxomite.org", filter for stream logs:

```
   index=botsv1 sourcetype=stream:http src=192.168.250.100 url=*solidaritedeproximite.org*
   | table src dest_ip url _time
```
![image17](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/06f7720e-c547-47c9-ac09-1984c1f5d8cd)


- Since we have seen a suspicious image on that domain, check the FortiGate firewall for the data it captured from "mhtr.jpg":
  
```
   index=botsv1 sourcetype=fgt_utm src=192.168.250.100 mhtr.jpg 
   | table _time src dest msg url action
```
![image18](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/731f5d46-0555-442d-b00d-4456c7457405)

### Threat Details:
- **Hostname:** we8105desk
- **IP Address:** 192.168.250.100
- **USB Key Name:** MIRANDA_PRI
- **Malicious File:** Miranda_Tate_unveiled.dotm 

## File Server
- **Hostname:** we9041srv
- **IP Address:** 192.168.250.20, 92.22.104.182
- **File Name:** mhtr.jpg

### Initial Connection
- solidaritedeproximite.org

### 8. Event Chaining - Identifying Parent/Child Processes

**Question:** What is the parent process ID of `121214.tmp`?

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

Starting with this query below to filter `121214.tmp` on Sysmon logs:
![image19](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/ce462d0e-672e-4bdc-a80b-acf132a9c661)

- Focusing on the `CommandLine` field name and displaying important fields in tabular form from this search query:

```
   index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational 121214.tmp CommandLine=* 
   | reverse 
   | table _time ParentCommandLine ParentProcessId ProcessId CommandLine
```
![image20](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/bdb0afd7-3930-4b6e-98c9-98c36de056e9)

### 9. Determine Which Signatures Specific to the Ransomware Alerted

**Question:** Amongst the Suricata signatures that detected the Cerber malware, which signature ID alerted the fewest number of times?

**Sourcetypes:**
- suricata

Searching the Suricata logs and filtering the signature type to "cerber":
![image21](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/c0c38e66-eb5d-46ad-88e5-1364c6dd4303)

- Suricata signatures and IDs sorted from lowest to highest:
```
   index=botsv1 sourcetype=suricata alert.signature=*cerber* 
   | stats count by alert.signature alert.signature_id 
   | sort count
```
 ![image22](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/5d8d1338-81d7-4243-bfc4-3ddc5a8de4f2)

### 10. Damage Assessment - Identifying Encrypted Text Files

**Question:** The Cerber ransomware encrypts files located in Bob Smith's Windows profile. How many `.txt` files does it encrypt?

**Resources:**
- Microsoft Sysmon Event Code Reference

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

- Searching all `.txt` file extensions in Windows Sysmon Logs:

![image23](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/f038b966-78dd-4526-bb48-6a4c1ddbc09b)

- Filtering the specific "Event Code 2" and `TargetFilename` of the target user:

  ```
   index=botsv1 sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational host=we8105desk *.txt EventCode=2 TargetFilename="C:\\Users\\bob.smith.WAYNECORPINC\\*.txt" 
   | stats dc(TargetFilename) AS unique_count
  ```
![image24](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/ecc22ca9-b361-4a7f-a0f4-2faaeb5f13ed)

### 11. Damage Assessment - Identifying Distinct PDFs Encrypted

**Question:** How many distinct PDFs did the ransomware encrypt on the remote file server?

**Resources:**
- Microsoft Sysmon Event Code Reference

**Sourcetypes:**
- XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

- Search through all "win" sourcetypes and filter the keyword "pdf":

![image25](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/5d9f9497-2adb-42a2-9230-e647c67cf454)

- Add the source address of the machine and count the unique PDF files in the "Relative_Target_Name" field name:

```
   index=botsv1 sourcetype=*win* pdf dest=we9041srv.waynecorpinc.local Source_Address=192.168.250.100 
| stats dc(Relative_Target_Name) AS unique_count
```
![image26](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/ab064e88-b9e8-4516-8302-38373c1527e7)

### 12. Identifying Redirection Post Encryption to a Domain

**Question:** What fully qualified domain name (FQDN) does the Cerber ransomware attempt to direct the user to at the end of its encryption phase?

**Resources:**
- URL Toolbox on Splunkbase

**Sourcetypes:**
- stream:dns

- Initial search query for the specific ip address "192.168.250.100"
![image27](https github.com/michaelsayala/splunk-boss-soc/assets/110712766/55b7f5f1-4b3b-4258-bf29-2bf43b2f1d5a)

- To find out the cerber ransomeware attempt to direct re-use the url filter we whitelist before

```
   index=botsv1 sourcetype=stream:DNS src=192.168.250.100 record_type=A NOT (query{}=*.microsoft.com OR query{}=*.waynecorpinc.local OR query{}=*.bing.com OR query{}=isatap OR query{}=wpad OR query{}=*.windows.com OR query{}=*.msftncsi.com) 
   | table _time query{} src dest 
   | sort - _time
```
![image28](https://github.com/michaelsayala/splunk-boss-soc/assets/110712766/377d6deb-0e6e-4330-bcae-157f80782f02)




 
